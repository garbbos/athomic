var cons={NAME:"AthomicDB",VERSION:1},setup={NAME:"SetupDB",VERSION:1},empresa=["cif","name","telefono","email","url","domicilio","provincia","cp","pais"],i=0,clientDB=[],vector=[],cliente={},forms=$("input.myconf"),panel=$("#panel"),btn_delete=$("#deleteID"),popup_nuevo_cliente=$("#nuevo_cliente"),popup_delete=$("#popup_delete"),deltitulo=$("#deltitulo"),paneltitulo=$("#panel_titulo"),lista=$("#lista"),listapanel=$("#datapanel"),selectfile=document.getElementById("selectfile"),nuevobill=$("#nuevobill"),formbill=$("#form_bill"),titulobill=$("#titulobill"),numerobill=$("#numerobill"),fechabill=$("#fechabill"),concepto=$("#concepto"),cantidad=$("#cantidad"),precio=$("#precio"),titulo=$("#titulo_nuevo");function texto(b){var a=$("#status_bar");window.console.log(b);$("#status_msg").text(b);a.animate({opacity:".9"});setTimeout(function(){a.animate({opacity:"0"})},3000)}function getFullDate(){var e=new Date(),f,b,c;f=e.getDate();b=e.getMonth();b=b+1;c=e.getFullYear();e=(f+"/"+b+"/"+c);window.console.log("Date: "+e);return e}function clear(a){if(a){a.each(function(){$(this).val("")})}}function getBill(a){var b=parseInt(localStorage.getItem(a),10);if(b){window.console.log("No Factura grabado: "+b);b=b+1}else{b=1}localStorage.setItem(a,b);return b}function edit(a){var b;if(a){panel.panel("close");clear(forms);titulo.text("Update Client");for(b in empresa){if(empresa.hasOwnProperty(b)){window.console.log("Edit... "+JSON.stringify(a[empresa[b]]));if(a[empresa[b]]){document.formo.elements[b].value=a[empresa[b]];popup_nuevo_cliente.popup("open",{positionTo:"window",transition:"flip"})}}}}}function bill(){var b,a=$("#name");if(paneltitulo.text()==="Athomic"){titulobill.text(a.text())}else{titulobill.text(paneltitulo.text())}b="00000"+getBill(titulobill.text());numerobill.text(b);fechabill.text(getFullDate());nuevobill.popup();nuevobill.popup("open",{positionTo:"window",transition:"flip"})}function newcli(){window.console.log(titulo.text());clear(forms);if(paneltitulo.text()==="Athomic"){popup_nuevo_cliente.popup("open",{positionTo:"window",transition:"flip"})}else{bill()}}function getSetup(){var a,b=[];window.console.log("Setup...");for(a in empresa){if(empresa.hasOwnProperty(a)){b.push(localStorage.getItem(empresa[a]))}}if(b){return b}else{texto("Setup: Empty data.");return}}function mysetup(){var a,b;clear(forms);titulo.text("Setup");a=getSetup();if(a){for(b in a){if(a.hasOwnProperty(b)){document.formo.elements[b].value=a[b]}}}popup_nuevo_cliente.popup("open",{positionTo:"window",transition:"flip"})}function saveSetup(a){var b;for(b in a){if(a.hasOwnProperty(b)){localStorage.setItem(b,a[b])}}}function importfile(){panel.panel("close");if(window.File&&window.FileReader&&window.FileList&&window.Blob){$("#readfile").popup("open",{positionTo:"window",transition:"flip"})}else{texto("Error: Not support File Api")}}function readForExport(a){clientDB.push(a)}function exportdata(){popup_delete.popup("open",{positionTo:"window",transition:"flip"});deltitulo.text("Export...");openDB.odb.open(cons,null,readForExport,"read")}function deleteID(){panel.panel("close");deltitulo.text("Deleting...");popup_delete.popup("open",{positionTo:"window",transition:"flip"})}function refreshBill(c){var f,a,b,d=[],e=[];if(c){$("<li>").append("<a href='#' id="+c.name+"><h3>"+c.titulo+"</h3><p>Date: "+c.fecha+"&nbsp;&nbsp;&nbsp;&nbsp;Bill Nº: "+c.name+"&nbsp;&nbsp;&nbsp;&nbsp;</p></a>").appendTo(lista);titulobill.text(c.titulo);f="#"+c.name;$(f).click(function(k){var l,g,j,m={},h=[];k.stopPropagation();listapanel.empty();for(l in c){if(c.hasOwnProperty(l)){if(l!=="titulo"){if(l==="name"){j="#fac"+c[l];$("<li>").append("<a href='#' class='color' id=fac"+c[l]+">Nº "+c[l]+"</a>").appendTo(listapanel)}else{for(g in c[l]){if(c[l].hasOwnProperty(g)&&(g==="concepto")){a=c[l].cantidad*c[l].precio;$("<li class='color myfactura'>").append("<span class='cantidad'>"+c[l].cantidad+"</span><span>&nbsp;"+c[l][g]+"</span><span>&nbsp;&nbsp;&nbsp;"+a+"&#8364;</span>").appendTo(listapanel);m={id:j,data:c[l]};h.push(m)}}}}}}$(j).click(function(n){var o;panel.panel("close");d=getSetup();if(d[1]){MYPDF.init();MYPDF.setup(d);MYPDF.date(c.fecha);MYPDF.fac(c.name);MYPDF.name(c.titulo);openDB.odb.open(cons,c.titulo,MYPDF.client,"get");for(o in h){if(h.hasOwnProperty(o)){if(h[o].id===j){MYPDF.bill(h[o].data)}}}}else{texto("Setup is empty, write it!!")}});btn_delete.text(c.name);listapanel.listview("refresh");panel.panel("open")});lista.listview("refresh")}}function bills(a){if(a){var b={NAME:a,VERSION:1};paneltitulo.text(a);panel.panel("close");lista.empty();openDB.odb.open(b,null,refreshBill,"read")}}function checkInput(a){if(a){if(!a.val()){a.css("background-color","#ffcc66").attr("placeholder","*Concept is required*").trigger("create");a.on("focusin",function(){a.css("background-color","#ffffff").trigger("create")});return false}else{return true}}}function Conceptos(a,c,b){this.concepto=a;this.cantidad=c;this.precio=b}function nextbill(){var b,a=$("#texto_concepto");if(checkInput(concepto)&&checkInput(cantidad)&&checkInput(precio)){b=new Conceptos(concepto.val(),cantidad.val(),precio.val());vector.push(b);a.html("<span><b style='font'>"+concepto.val()+"</b></span>");window.console.log("Bill: "+JSON.stringify(vector))}concepto.val("");cantidad.val("");precio.val("")}function saveallbill(){var d,b,a={},c={NAME:titulobill.text(),VERSION:1};a.name=numerobill.text();a.titulo=titulobill.text();a.fecha=fechabill.text();nextbill();if(vector){for(d in vector){if(vector.hasOwnProperty(d)){b="concepto"+d;a[b]=vector[d]}}window.console.log("Vector: "+JSON.stringify(vector))}window.console.log("Factura: "+JSON.stringify(a));openDB.odb.open(c,a,texto,"add");clear(formbill);vector=[];bills(a.titulo)}var refreshClientes=function(a){var d,b="#cif",c="#name";if(a){window.console.log("refreshClientes..."+JSON.stringify(a[empresa[1]]));$("<li>").append("<a href='#' id="+a[empresa[1]]+"><h3><span>"+a[empresa[1]]+"</span></h3><p><span>"+a[empresa[0]]+"</span><span>&nbsp;&nbsp;&nbsp;&nbsp;"+a[empresa[2]]+"</span><span>&nbsp;&nbsp;&nbsp;&nbsp;"+a[empresa[3]]+"</span></p></a>").appendTo(lista);d="#"+a[empresa[1]];$(d).click(function(e){var f;window.console.log(d+".click");e.stopPropagation();listapanel.empty();for(f in a){if(a.hasOwnProperty(f)){if(a[f]){if(f==="cif"){$("<li>").append("<a href='#' class='color' id="+f+">"+a[f]+"</a>").appendTo(listapanel)}else{if(f==="name"){$("<li>").append("<a href='#' class='color' id="+f+">"+a[f]+"</a>").appendTo(listapanel)}else{$("<li class='color'>").append("<span>"+a[f]+"</span>").appendTo(listapanel)}}}}}$(b).click(function(g){window.console.log(b+".click");bills(a[empresa[1]])});$(c).click(function(g){window.console.log(c+".click");edit(a)});listapanel.listview("refresh");panel.panel("open")});lista.listview("refresh")}};function loadDB(){paneltitulo.text("Athomic");lista.empty();openDB.odb.open(cons,"",refreshClientes,"read")}function reqText(b){var a,c;a=JSON.parse(b);if(a){for(c in a){if(a.hasOwnProperty(c)){openDB.odb.open(cons,a[c],texto,"add");window.console.log("Record: "+a[c].name)}}loadDB()}}function importData(c){var b,a;$("#readfile").popup("close");b=c.target.files[0];if(b){a=new FileReader();a.onload=function(f){var d=f.target.result;reqText(d)};a.readAsText(b)}}function save_client(){var g,b,e=true,f={},a=$("#id_cif"),c=$("#id_nombre"),d=$("#id_telefono");for(g in empresa){if(empresa.hasOwnProperty(g)){f[empresa[g]]=document.formo.elements[g].value;window.console.log("save_client "+g+" "+document.formo.elements[g].value)}}if(!f[empresa[0]]){a.css("background-color","#ffcc66").attr("placeholder","*CIF	 is required*").trigger("create");a.on("focusin",function(){a.css("background-color","#ffffff").trigger("create")});e=false}if(!f[empresa[1]]){c.css("background-color","#ffcc66").attr("placeholder","*Nombre is required*").trigger("create");c.on("focusin",function(){c.css("background-color","#ffffff").trigger("create")});e=false}if(!f[empresa[2]]||(f[empresa[2]].length<9)){d.css("background-color","#ffcc66").attr("placeholder","*Teléfono is required*").trigger("create");d.on("focusin",function(){d.css("background-color","#ffffff").trigger("create")});e=false}if(e){popup_nuevo_cliente.popup("close");if(titulo.text()==="New Client"){openDB.odb.open(cons,f,texto,"add")}else{if(titulo.text()==="Update Client"){openDB.odb.open(cons,f,texto,"update");titulo.text("New Client")}else{if(titulo.text()==="Setup"){saveSetup(f);titulo.text("New Client")}}}loadDB()}}function delDB(){var g,b="AthomicDB.json",a,e,c=$("#name"),f={};if(deltitulo.text()==="Export..."){try{if(clientDB){a=new Blob([JSON.stringify(clientDB)],{type:"application/json"});saveAs(a,b);texto("AthomicDB is saved.")}else{texto("No data in DataBase.")}}catch(d){texto("Error: Athomic.json is not saved. "+d.message)}}else{if(paneltitulo.text()==="Athomic"){g=c.text();openDB.odb.open(cons,g,texto,"delete");f={NAME:g,VERSION:1};openDB.odb.open(f,null,texto,"deleteDB");loadDB()}else{f={NAME:paneltitulo.text(),VERSION:1};e=btn_delete.text();g=paneltitulo.text();window.console.log("delDB: Nombre de panel "+g);openDB.odb.open(f,e,texto,"delete");lista.empty();openDB.odb.open(f,g,refreshBill,"read")}}}function loadEvents(){var f=$("#reload"),h=$("#id_nuevo_cliente"),k=$("#setup"),d=$("#import"),b=$("#export"),g=$("#btn_save"),j=$("#btn_popup_delete"),e=$("#btn_save_bill"),c=$("#btn_next_bill"),a=$("#lista");selectfile.addEventListener("change",importData,false);f.click(function(){loadDB()});k.click(function(){mysetup()});d.click(function(){importfile()});b.click(function(){exportdata()});h.click(function(){newcli()});g.click(function(){save_client()});btn_delete.click(function(){deleteID()});e.click(function(){saveallbill()});c.click(function(){nextbill()});j.click(function(){delDB()})}window.onload=function(){window.console.log("window.onload()... ");loadDB();loadEvents()};