var cons={NAME:"AthomicDB",VERSION:1},empresa=["cif","name","telefono","email","url","domicilio","cp","poblacion","pais"],i=0,vector=[],clientDB=[],forms=$("input.myconf"),panel=$("#panel"),btn_delete=$("#deleteID"),popup_nuevo_cliente=$("#nuevo_cliente"),popup_delete=$("#popup_delete"),deltitulo=$("#deltitulo"),paneltitulo=$("#panel_titulo"),lista=$("#lista"),listapanel=$("#datapanel"),selectfile=document.getElementById("selectfile"),nuevobill=$("#nuevobill"),formbill=$("#form_bill"),titulobill=$("#titulobill"),numerobill=$("#numerobill"),fechabill=$("#fechabill"),concepto=$("#concepto"),cantidad=$("#cantidad"),precio=$("#precio"),titulo=$("#titulo_nuevo");function texto(b){var a=$("#status_bar");window.console.log(b);$("#status_msg").text(b);a.animate({opacity:"1"});setTimeout(function(){a.animate({opacity:"0"})},3000)}function getFullDate(){var e=new Date(),f,b,c;f=e.getDate();b=e.getMonth();b=b+1;c=e.getFullYear();e=(f+"/"+b+"/"+c);return e}function clear(a){if(a){a.each(function(){$(this).css("background-color","#ffffff");$(this).val("")})}}function getBill(a){var b=parseInt(localStorage.getItem(a),10);if(b){b=b+1}else{b=1}localStorage.setItem(a,b);return b}function edit(a){var b;if(a){panel.panel("close");clear(forms);titulo.text("Update Client");for(b in empresa){if(empresa.hasOwnProperty(b)){if(a[empresa[b]]){document.formo.elements[b].value=a[empresa[b]];popup_nuevo_cliente.popup("open",{positionTo:"window",transition:"flip"})}}}}}function bill(){var c,b=$("#name"),a=$("#texto_concepto");if(paneltitulo.text()==="Athomic"){titulobill.text(b.text())}else{titulobill.text(paneltitulo.text())}c="000000"+getBill(titulobill.text());numerobill.text(c);fechabill.text(getFullDate());concepto.val("");cantidad.val("");precio.val("");a.html("");vector=[];nuevobill.popup();nuevobill.popup("open",{positionTo:"window",transition:"flip"})}function newcli(){clear(forms);if(paneltitulo.text()==="Athomic"){titulo.text("New Client");popup_nuevo_cliente.popup("open",{positionTo:"window",transition:"flip"})}else{titulo.text("New Bill");bill()}}function getSetup(){var a,b=[];for(a in empresa){if(empresa.hasOwnProperty(a)){b.push(localStorage.getItem(empresa[a]))}}if(b){return b}else{return false}}function mysetup(){var a,b;clear(forms);titulo.text("MySetup");a=getSetup();if(a){for(b in a){if(a.hasOwnProperty(b)){document.formo.elements[b].value=a[b]}}}popup_nuevo_cliente.popup("open",{positionTo:"window",transition:"flip"})}function saveSetup(a){var b;for(b in a){if(a.hasOwnProperty(b)){localStorage.setItem(b,a[b])}}texto("Setup saved!!")}function importfile(){panel.panel("close");if(window.File&&window.FileReader&&window.FileList&&window.Blob){$("#readfile").popup("open",{positionTo:"window",transition:"flip"})}else{texto("Error: Not support File Api")}}function readForExport(a){clientDB.push(a)}function exportdata(){popup_delete.popup("open",{positionTo:"window",transition:"flip"});deltitulo.text("Export...");clientDB=[];openDB.odb.open(cons,null,readForExport,"read")}function deleteID(){panel.panel("close");deltitulo.text("Deleting...");popup_delete.popup("open",{positionTo:"window",transition:"flip"})}function refreshBill(b){var d,a,c=[];if(b){$("<li>").append("<a href='#' id="+b.name+"><h3>"+b.titulo+"</h3><p>Date: "+b.fecha+"&nbsp;&nbsp;&nbsp;&nbsp;Bill Nº: "+b.name+"&nbsp;&nbsp;&nbsp;&nbsp;</p></a>").appendTo(lista);titulobill.text(b.titulo);d="#"+b.name;$(d).click(function(g){var h,e,f;g.stopPropagation();listapanel.empty();MYPDF.init();openDB.odb.open(cons,b.titulo,MYPDF.client,"get");for(h in b){if(b.hasOwnProperty(h)){if(h!=="titulo"){if(h==="name"){f="#fac"+b[h];$("<li>").append("<a href='#' class='color' id=fac"+b[h]+">Nº "+b[h]+"</a>").appendTo(listapanel)}else{if(h==="fecha"){$("<li class='color'>").append("<span>"+b[h]+"</span>").appendTo(listapanel)}else{for(e in b[h]){if(b[h].hasOwnProperty(e)&&(e==="concepto")){a=b[h].cantidad*b[h].precio;$("<li class='color'>").append("<span class='cantidad'>"+b[h].cantidad+"</span><span>&nbsp;"+b[h][e]+"</span><span>&nbsp;&nbsp;&nbsp;"+a+"&#8364;</span>").appendTo(listapanel);MYPDF.bill(b[h].concepto,b[h].cantidad,b[h].precio)}}}}}}}$("#btn_generating").click(function(j){MYPDF.save($("#comments").val());$("#genPDF").popup("close")});$(f).click(function(j){panel.panel("close");MYPDF.name(b.titulo);MYPDF.date(b.fecha);MYPDF.fac(b.name);c=getSetup();if(c[1]){MYPDF.setup(c);$("#comments").val("");$("#genPDF").popup("open",{positionTo:"window",transition:"flip"})}else{texto("Setup is empty, write it!!")}});btn_delete.text(b.name);listapanel.listview("refresh");panel.panel("open")});lista.listview("refresh")}}function bills(a){if(a){var b={NAME:a,VERSION:1};paneltitulo.text(a);panel.panel("close");lista.empty();openDB.odb.open(b,null,refreshBill,"read")}}function checkInput(a){a.css("background-color","#ffcc66").trigger("create");a.on("focusin",function(){a.css("background-color","#ffffff").trigger("create")})}function Conceptos(a,c,b){this.concepto=a;this.cantidad=c;this.precio=b}function nextbill(){var b,a=$("#texto_concepto");if(concepto.val()){if((cantidad.val())&&(cantidad.val()>0)){if((precio.val())&&(precio.val()>0)){b=new Conceptos(concepto.val(),cantidad.val(),precio.val());vector.push(b);a.html("<span><b style='font'>"+concepto.val()+"</b></span>");concepto.val("");cantidad.val("");precio.val("");return true}else{checkInput(precio);a.text("Price is required.");return false}}else{checkInput(cantidad);a.text("Items is required.");return false}}else{checkInput(concepto);a.text("Concept is required.");return false}}function saveallbill(){var d,b,a={},c={NAME:titulobill.text(),VERSION:1};a.titulo=titulobill.text();a.name=numerobill.text()+a.titulo.substring(0,1);a.fecha=fechabill.text();if(nextbill()){for(d in vector){if(vector.hasOwnProperty(d)){b="concepto"+d;a[b]=vector[d]}}openDB.odb.open(c,a,texto,"add");nuevobill.popup("close");bills(a.titulo)}}var refreshClientes=function(b){var e,a="",c="#cif",d="#name";if(b){if(b[empresa[3]]){a=b[empresa[3]]}$("<li>").append("<a href='#' id="+b[empresa[1]]+"><h3><span>"+b[empresa[1]]+"</span></h3><p><span>"+b[empresa[0]]+"</span><span>&nbsp;&nbsp;&nbsp;&nbsp;"+b[empresa[2]]+"</span><span>&nbsp;&nbsp;&nbsp;&nbsp;"+a+"</span></p></a>").appendTo(lista);e="#"+b[empresa[1]];$(e).click(function(f){var g;f.stopPropagation();listapanel.empty();for(g in b){if(b.hasOwnProperty(g)){if(b[g]){if(g==="cif"){$("<li>").append("<a href='#' class='color' id="+g+">"+b[g]+"</a>").appendTo(listapanel)}else{if(g==="name"){$("<li>").append("<a href='#' class='color' id="+g+">"+b[g]+"</a>").appendTo(listapanel)}else{$("<li class='color'>").append("<span>"+b[g]+"</span>").appendTo(listapanel)}}}}}$(c).click(function(h){bills(b[empresa[1]])});$(d).click(function(h){edit(b)});listapanel.listview("refresh");panel.panel("open")});lista.listview("refresh")}};function loadDB(){paneltitulo.text("Athomic");lista.empty();openDB.odb.open(cons,"",refreshClientes,"read");btn_delete.text("delete")}function reqText(b){var a,c;a=JSON.parse(b);if(a){for(c in a){if(a.hasOwnProperty(c)){openDB.odb.open(cons,a[c],texto,"add")}}loadDB()}}function importData(c){var b,a;$("#readfile").popup("close");b=c.target.files[0];if(b){a=new FileReader();a.onload=function(f){var d=f.target.result;reqText(d)};a.readAsText(b)}}function saveRecord(a){if(titulo.text()==="New Client"){openDB.odb.open(cons,a,texto,"add")}else{if(titulo.text()==="Update Client"){openDB.odb.open(cons,a,texto,"update");titulo.text("New Client")}else{if(titulo.text()==="MySetup"){saveSetup(a);titulo.text("New Client")}}}}function save_client(){var d={},c=$("#id_cif"),k=$("#id_nombre"),g=$("#id_telefono"),e=$("#id_email"),a=$("#id_url"),h=$("#id_domicilio"),f=$("#id_cp"),j=$("#id_poblacion"),b=$("#id_pais");if(/\w/.test(c.val())&&/\d/.test(c.val())){texto("cif correcto");d.cif=c.val()}else{checkInput(c)}if(/\w/.test(k.val())){texto("nombre correcto");d.name=k.val()}else{checkInput(k)}if(/^(\+\d{2,3}\s)*\d{9,10}$/.test(g.val())){texto("telefono correcto");d.telefono=g.val()}else{checkInput(g)}if(/^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/.test(e.val())){texto("Email is not valid.");d.email=e.val()}else{if(e.val()){d.cif="";d.email="";checkInput(e)}}if(/^http[s]?:\/\/[\w]+([\.]+[\w]+)+$/.test(a.val())){d.url=a.val()}else{if(a.val()){d.cif="";d.url="";checkInput(a)}}if(/\w/.test(f.val())){d.cp=f.val()}else{if(f.val()){d.cif="";d.cp="";checkInput(f)}}if(d.name&&d.cif&&d.telefono){popup_nuevo_cliente.popup("close");d.domicilio=h.val();d.poblacion=j.val();d.pais=b.val();saveRecord(d);loadDB()}}function delDB(){var d,b="AthomicDB.json",a,f,c=$("#name"),g={};if(deltitulo.text()==="Export..."){try{if(clientDB){a=new Blob([JSON.stringify(clientDB)],{type:"application/json"});saveAs(a,b);texto("AthomicDB is saved.")}else{texto("No data in DataBase.")}}catch(e){texto("Error: Athomic.json is not saved. "+e.message)}}else{if(paneltitulo.text()==="Athomic"){d=c.text();openDB.odb.open(cons,d,texto,"delete");g={NAME:d,VERSION:1};openDB.odb.open(g,null,texto,"deleteDB");loadDB()}else{g={NAME:paneltitulo.text(),VERSION:1};f=btn_delete.text();d=paneltitulo.text();openDB.odb.open(g,f,texto,"delete");lista.empty();openDB.odb.open(g,d,refreshBill,"read")}}}function loadEvents(){var e=$("#reload"),g=$("#id_nuevo_cliente"),j=$("#setup"),c=$("#import"),a=$("#export"),f=$("#btn_save"),h=$("#btn_popup_delete"),d=$("#btn_save_bill"),b=$("#btn_next_bill");selectfile.addEventListener("change",importData,false);e.click(function(){loadDB()});j.click(function(){mysetup()});c.click(function(){importfile()});a.click(function(){exportdata()});g.click(function(){newcli()});f.click(function(){save_client()});btn_delete.click(function(){deleteID()});d.click(function(){saveallbill()});b.click(function(){nextbill()});h.click(function(){delDB()})}window.onload=function(){loadDB();loadEvents()};